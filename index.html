<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login | EduFlow ERP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="style.css">
</head>

<body class="bg-slate-100 min-h-screen flex items-center justify-center p-4 font-sans">

    <div class="max-w-md w-full bg-white rounded-3xl shadow-2xl p-8">
        <div class="text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">EduFlow ERP</h1>
            <p class="text-gray-500 text-sm">Choose your login method</p>
        </div>

        <button id="googleBtn"
            class="w-full flex items-center justify-center gap-3 border border-gray-300 p-3 rounded-xl hover:bg-gray-50 transition mb-6 group">
            <img src="https://www.svgrepo.com/show/355037/google.svg" class="w-5 h-5 group-hover:scale-110 transition">
            <span class="font-bold text-gray-700">Continue with Google</span>
        </button>

        <div class="relative flex py-2 items-center mb-4">
            <div class="flex-grow border-t border-gray-200"></div>
            <span class="flex-shrink mx-4 text-gray-400 text-xs font-bold uppercase">Email Access</span>
            <div class="flex-grow border-t border-gray-200"></div>
        </div>

        <div class="space-y-3 mb-6">
            <input type="email" id="email" placeholder="Email Address"
                class="w-full p-3 rounded-lg border border-gray-200 focus:ring-2 focus:ring-indigo-500 outline-none">
            <input type="password" id="password" placeholder="Password"
                class="w-full p-3 rounded-lg border border-gray-200 focus:ring-2 focus:ring-indigo-500 outline-none">

            <div class="flex gap-2">
                <button id="emailLoginBtn"
                    class="flex-1 bg-indigo-600 text-white p-3 rounded-lg font-bold hover:bg-indigo-700 transition">Login</button>
                <button id="emailRegisterBtn"
                    class="flex-1 bg-white text-indigo-600 border border-indigo-600 p-3 rounded-lg font-bold hover:bg-indigo-50 transition">Register</button>
            </div>
        </div>

        <div class="relative flex py-2 items-center mb-4">
            <div class="flex-grow border-t border-gray-200"></div>
            <span class="flex-shrink mx-4 text-gray-400 text-xs font-bold uppercase">Mobile Access</span>
            <div class="flex-grow border-t border-gray-200"></div>
        </div>

        <div class="space-y-3">
            <div class="flex gap-2">
                <input type="text" id="phoneNumber" placeholder="+1 555 555 5555"
                    class="w-full p-3 rounded-lg border border-gray-200 focus:ring-2 focus:ring-indigo-500 outline-none">
                <button id="sendOtpBtn"
                    class="bg-gray-800 text-white px-4 rounded-lg font-bold hover:bg-black transition whitespace-nowrap">Get
                    OTP</button>
            </div>

            <div id="otpSection" class="hidden space-y-3 fade-in">
                <input type="text" id="otpInput" placeholder="Enter 6-digit OTP"
                    class="w-full p-3 rounded-lg border border-indigo-300 bg-indigo-50 focus:ring-2 focus:ring-indigo-500 outline-none text-center tracking-widest font-bold text-lg">
                <button id="verifyOtpBtn"
                    class="w-full bg-green-600 text-white p-3 rounded-lg font-bold hover:bg-green-700 transition">Verify
                    & Login</button>
            </div>

            <div id="recaptcha-container"></div>
        </div>

        <p id="statusMsg" class="text-xs text-center text-gray-500 mt-6 min-h-[20px]"></p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import {
            getAuth,
            GoogleAuthProvider,
            signInWithPopup,
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            RecaptchaVerifier,
            signInWithPhoneNumber
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // YOUR REAL KEYS
        const firebaseConfig = {
            apiKey: "AIzaSyDMlz7bGhs_b8LRMymV_nmmc5wRw9RFI3Y",
            authDomain: "eduflow-c580c.firebaseapp.com",
            projectId: "eduflow-c580c",
            storageBucket: "eduflow-c580c.firebasestorage.app",
            messagingSenderId: "254648339709",
            appId: "1:254648339709:web:e7c775b3c0bfcdeed38294",
            measurementId: "G-X84H009N6G"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        auth.useDeviceLanguage(); // Sets language to user's device setting

        // Elements
        const statusMsg = document.getElementById('statusMsg');

        // Helper to redirect
        function loginSuccess(user) {
            console.log("Logged in:", user);
            statusMsg.innerText = `Success! Welcome ${user.displayName || user.email || user.phoneNumber}`;
            statusMsg.className = "text-xs text-center text-green-600 mt-6 font-bold";

            localStorage.setItem('userName', user.displayName || user.email || "Mobile User");
            localStorage.setItem('userPhoto', user.photoURL || "");

            setTimeout(() => { window.location.href = "dashboard.html"; }, 1500);
        }

        function showError(error) {
            console.error(error);
            let msg = error.message;
            if (msg.includes("auth/invalid-email")) msg = "Invalid Email Address.";
            if (msg.includes("auth/wrong-password")) msg = "Wrong Password.";
            if (msg.includes("auth/user-not-found")) msg = "User not found. Try Registering.";
            if (msg.includes("auth/email-already-in-use")) msg = "Email already exists. Try Logging in.";

            statusMsg.innerText = msg;
            statusMsg.className = "text-xs text-center text-red-500 mt-6 font-bold";
        }

        // ------------------------------------
        // 1. GOOGLE LOGIN
        // ------------------------------------
        const provider = new GoogleAuthProvider();
        document.getElementById('googleBtn').addEventListener('click', () => {
            statusMsg.innerText = "Connecting to Google...";
            signInWithPopup(auth, provider).then((res) => loginSuccess(res.user)).catch(showError);
        });

        // ------------------------------------
        // 2. EMAIL & PASSWORD
        // ------------------------------------
        const emailInput = document.getElementById('email');
        const passInput = document.getElementById('password');

        document.getElementById('emailLoginBtn').addEventListener('click', () => {
            if (!emailInput.value || !passInput.value) { showError({ message: "Enter email & password" }); return; }
            statusMsg.innerText = "Verifying credentials...";
            signInWithEmailAndPassword(auth, emailInput.value, passInput.value)
                .then((res) => loginSuccess(res.user)).catch(showError);
        });

        document.getElementById('emailRegisterBtn').addEventListener('click', () => {
            if (!emailInput.value || !passInput.value) { showError({ message: "Enter email & password" }); return; }
            statusMsg.innerText = "Creating account...";
            createUserWithEmailAndPassword(auth, emailInput.value, passInput.value)
                .then((res) => loginSuccess(res.user)).catch(showError);
        });

        // ------------------------------------
        // 3. PHONE NUMBER LOGIN
        // ------------------------------------
        window.recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', {
            'size': 'invisible', // It won't show unless suspicious
            'callback': (response) => {
                // reCAPTCHA solved, allow signInWithPhoneNumber.
            }
        });

        document.getElementById('sendOtpBtn').addEventListener('click', () => {
            const phoneNumber = document.getElementById('phoneNumber').value;
            if (!phoneNumber) { showError({ message: "Enter Phone Number (e.g. +1...)" }); return; }

            statusMsg.innerText = "Sending OTP...";
            const appVerifier = window.recaptchaVerifier;

            signInWithPhoneNumber(auth, phoneNumber, appVerifier)
                .then((confirmationResult) => {
                    // SMS sent. Prompt user to type the code.
                    window.confirmationResult = confirmationResult;
                    statusMsg.innerText = "OTP Sent! Check your SMS.";
                    statusMsg.className = "text-xs text-center text-blue-600 mt-6 font-bold";

                    // Show OTP Input
                    document.getElementById('otpSection').classList.remove('hidden');
                }).catch(showError);
        });

        document.getElementById('verifyOtpBtn').addEventListener('click', () => {
            const code = document.getElementById('otpInput').value;
            if (!code) return;

            statusMsg.innerText = "Verifying Code...";
            window.confirmationResult.confirm(code).then((result) => {
                loginSuccess(result.user);
            }).catch(showError);
        });
    </script>
</body>

</html>