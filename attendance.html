<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance | EduFlow</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* CSS for the Checkbox */
        .custom-checkbox input:checked+div {
            background-color: #10B981;
            /* Green-500 */
            border-color: #10B981;
            color: white;
        }

        .custom-checkbox input:checked+div svg {
            display: block;
        }

        /* Highlight the row when checked */
        .attendance-row:has(input:checked) {
            background-color: #F0FDF4;
            /* Green-50 */
            border-color: #10B981;
        }

        /* LOCKED STATE (Grayed Out) */
        .locked-state {
            pointer-events: none;
            opacity: 0.6;
            filter: grayscale(100%);
        }

        /* Modal Styles */
        .modal {
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease-in-out;
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            transform: scale(0.95);
            transition: all 0.2s ease-in-out;
        }

        .modal.active .modal-content {
            transform: scale(1);
        }
    </style>
</head>

<body class="bg-gray-50 flex hidden" id="mainBody">

    <aside class="w-64 bg-white h-screen border-r border-gray-200 p-6 flex flex-col fixed z-50 hidden md:flex">
        <div class="mb-10 flex items-center gap-2">
            <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white font-bold">E</div>
            <h2 class="text-xl font-bold text-gray-800">EduFlow</h2>
        </div>
        <nav class="space-y-2">
            <a href="dashboard.html" class="block p-3 text-gray-600 hover:bg-gray-100 rounded-lg">Dashboard</a>
            <a href="documents.html" class="block p-3 text-gray-600 hover:bg-gray-100 rounded-lg">Documents</a>
            <a href="exams.html" class="block p-3 text-gray-600 hover:bg-gray-100 rounded-lg">Exams</a>
            <a href="assignments.html" class="block p-3 text-gray-600 hover:bg-gray-100 rounded-lg">Assignments</a>
            <a href="attendance.html" class="block p-3 bg-indigo-50 text-indigo-700 font-bold rounded-lg">Attendance</a>
        </nav>
    </aside>

    <main class="md:ml-64 p-8 w-full">
        <div class="flex justify-between items-end mb-8 relative">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">Attendance Tracker (CSE) [Sec -M1]</h1>
                <p class="text-gray-500 text-sm mt-1">Classes started from: <span class="font-bold text-gray-700">19 Jan
                        2026</span></p>
            </div>
            <div class="relative group z-[60]">
                <button class="flex items-center gap-3 hover:scale-105 transition focus:outline-none">
                    <div class="text-right hidden sm:block">
                        <p class="text-sm font-bold text-gray-700" id="headerUserName">Student</p>
                        <p class="text-xs text-green-500">Online</p>
                    </div>
                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Felix"
                        class="w-12 h-12 rounded-full border-2 border-indigo-500 shadow-lg bg-gray-100 object-cover">
                </button>

                <div
                    class="absolute right-0 mt-2 w-48 bg-white rounded-xl shadow-2xl border border-gray-100 overflow-hidden hidden group-hover:block transition-all duration-200 origin-top-right">
                    <div class="px-4 py-3 border-b border-gray-100 bg-gray-50">
                        <p class="text-xs font-bold text-gray-400 uppercase">Account</p>
                        <p class="text-sm font-bold text-gray-800 truncate" id="dropdownUserName">Student</p>
                    </div>
                    <a href="settings.html"
                        class="block px-4 py-3 text-gray-600 hover:bg-indigo-50 hover:text-indigo-600 transition flex items-center gap-2">
                        ‚öôÔ∏è Settings
                    </a>
                    <button onclick="localStorage.removeItem('userName'); window.location.href='index.html';"
                        class="w-full text-left px-4 py-3 text-red-500 hover:bg-red-50 transition font-bold flex items-center gap-2">
                        üö™ Logout
                    </button>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
            <div
                class="bg-white p-6 rounded-2xl flex flex-col justify-between h-32 relative overflow-hidden group shadow-lg border border-gray-100">
                <div class="flex justify-between items-center z-10">
                    <div class="text-gray-500 text-xs font-bold uppercase tracking-wider">Classes Held</div>
                    <div id="overallPercent"
                        class="text-xs font-black bg-indigo-100 text-indigo-700 px-2 py-1 rounded-md">--%</div>
                </div>
                <div class="text-4xl font-black text-gray-800 z-10" id="totalClasses">0</div>
                <div class="absolute right-0 bottom-0 opacity-10 text-9xl font-black text-gray-800 -mr-4 -mb-4">#</div>
            </div>

            <div
                class="bg-white p-6 rounded-2xl flex flex-col justify-between h-32 relative overflow-hidden group shadow-lg border border-green-100">
                <div class="text-green-600 text-xs font-bold uppercase tracking-wider">Present</div>
                <div class="text-4xl font-black text-green-500" id="totalPresent">0</div>
            </div>

            <div
                class="bg-white p-6 rounded-2xl flex flex-col justify-between h-32 relative overflow-hidden group shadow-lg border border-red-100">
                <div class="text-red-500 text-xs font-bold uppercase tracking-wider">Absent</div>
                <div class="text-4xl font-black text-red-500" id="totalAbsent">0</div>
            </div>

            <div onclick="openAnalysis()"
                class="bg-gradient-to-br from-indigo-600 to-purple-600 p-6 rounded-2xl flex flex-col justify-between h-32 relative overflow-hidden group shadow-lg cursor-pointer hover:scale-105 transition">
                <div class="text-indigo-100 text-xs font-bold uppercase tracking-wider">Smart Analysis</div>
                <div class="text-white font-bold text-lg flex items-center gap-2">Predict & Plan ‚Üí</div>
            </div>
        </div>

        <div class="bg-white p-8 rounded-2xl shadow-lg border border-gray-200 mb-10">
            <h2 class="text-2xl font-black text-gray-800 tracking-tight mb-6">Subject-wise Breakdown</h2>
            <div id="subjectWiseList" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </div>

        <div class="bg-white rounded-2xl shadow-lg border border-gray-200 overflow-hidden relative">

            <div
                class="p-6 border-b border-gray-100 flex flex-col md:flex-row justify-between items-center gap-4 bg-gray-50/50">
                <div class="flex items-center gap-2 bg-white p-1.5 rounded-xl border border-gray-200 shadow-sm">
                    <button onclick="changeDay(-1)"
                        class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-gray-100 text-gray-500 hover:text-indigo-600 transition">‚óÄ</button>
                    <div class="relative">
                        <input type="date" id="datePicker"
                            class="bg-gray-50 border border-gray-200 text-gray-700 text-sm rounded-lg font-bold cursor-pointer hover:bg-white transition block w-full p-2.5"
                            onchange="pickDate(this.value)">
                    </div>
                    <button onclick="changeDay(1)"
                        class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-gray-100 text-gray-500 hover:text-indigo-600 transition">‚ñ∂</button>
                </div>

                <div class="text-center md:text-left">
                    <h2 class="text-lg font-black text-gray-800" id="managerDayName">Today</h2>
                    <p class="text-xs text-gray-500 font-bold uppercase" id="managerDateStr">Date</p>
                </div>

                <div class="flex items-center gap-3" id="actionControls">

                    <div id="editControls" class="flex items-center gap-3">
                        <label
                            class="flex items-center gap-2 cursor-pointer group bg-white px-3 py-2 rounded-lg border border-gray-200 hover:border-orange-200 transition select-none">
                            <input type="checkbox" id="managerHolidayToggle" class="hidden peer">
                            <div
                                class="w-9 h-5 bg-gray-200 rounded-full peer-checked:bg-orange-500 transition-colors relative">
                                <div
                                    class="absolute left-1 top-1 bg-white w-3 h-3 rounded-full transition-transform peer-checked:translate-x-4 shadow-sm">
                                </div>
                            </div>
                            <span class="text-xs font-bold text-gray-500 group-hover:text-gray-700">Holiday</span>
                        </label>

                        <div class="h-8 w-px bg-gray-300 mx-1"></div>

                        <button onclick="managerMarkAll(true)"
                            class="px-3 py-2 bg-white border border-gray-200 text-green-600 text-xs font-bold rounded-lg hover:bg-green-50 transition">All
                            ‚úî</button>
                        <button onclick="managerMarkAll(false)"
                            class="px-3 py-2 bg-white border border-gray-200 text-red-500 text-xs font-bold rounded-lg hover:bg-red-50 transition">All
                            ‚úò</button>

                        <button onclick="saveDay()"
                            class="ml-2 px-5 py-2 bg-indigo-600 text-white text-sm font-bold rounded-lg hover:bg-indigo-700 transition shadow-md flex items-center gap-2">
                            üíæ Save
                        </button>
                    </div>

                    <div id="lockedControls" class="hidden flex items-center gap-3">
                        <span
                            class="text-xs font-bold text-green-600 bg-green-100 px-3 py-1.5 rounded-lg border border-green-200">üîí
                            Data Saved</span>
                        <button onclick="resetDay()"
                            class="px-4 py-2 bg-white border border-gray-300 text-gray-600 text-sm font-bold rounded-lg hover:bg-gray-100 hover:text-red-600 transition shadow-sm flex items-center gap-2">
                            üîÑ Reset
                        </button>
                    </div>

                </div>
            </div>

            <div class="p-6 bg-white min-h-[300px]">
                <div id="managerListContainer">
                    <div id="managerClassList" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
                </div>

                <div id="managerEmptyState"
                    class="hidden flex flex-col items-center justify-center py-10 text-center text-gray-400">
                    <div class="text-4xl mb-2 grayscale opacity-50">üò¥</div>
                    <p class="font-bold">No classes scheduled</p>
                </div>

                <div id="managerHolidayState"
                    class="hidden flex flex-col items-center justify-center py-12 text-center bg-orange-50 rounded-xl border border-orange-100 border-dashed">
                    <div class="text-5xl mb-4">üéâ</div>
                    <p class="text-orange-800 font-bold text-lg">Holiday Marked</p>
                    <p class="text-orange-500 text-sm font-medium">Enjoy your day off!</p>
                </div>
            </div>

        </div>
    </main>

    <div id="analysisModal"
        class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
        <div class="modal-content bg-white w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden">
            <div class="bg-indigo-600 p-6 text-white flex justify-between items-center">
                <h2 class="text-xl font-bold">Smart Analysis</h2>
                <button onclick="document.getElementById('analysisModal').classList.remove('active')"
                    class="font-bold text-2xl">&times;</button>
            </div>
            <div class="p-6 space-y-6 max-h-[70vh] overflow-y-auto">
                <div class="bg-blue-50 border border-blue-100 p-4 rounded-xl">
                    <h3 class="font-bold text-blue-800 mb-1">Target Roadmap (75%)</h3>
                    <div id="targetText" class="text-2xl font-bold text-indigo-600 mt-2">...</div>
                </div>
                <div id="criticalSubjects" class="space-y-2"></div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // 1. CONFIGURATION
        // ==========================================
        const routine = {
            "Monday": [
                { time: "08:00 - 09:40", subject: "Professional Skills Lab (Suruchi Ma'am)[NYB 006]" },
                { time: "09:40 - 10:30", subject: "Basic Electrical Electronics (Roopayali Ma'am)[NYB 202]" },
                { time: "10:30 - 11:20", subject: "Engineering Mathematics (Rakesh Sir)[NYB 202]" }
            ],
            "Tuesday": [
                { time: "08:00 - 09:40", subject: "Advance Excel Lab (Raminder Ma'am)[NYB 405]" },
                { time: "09:40 - 11:20", subject: "C++ Lab (Nidhi Ma'am)[NYB 406]" },
                { time: "11:20 - 12:05", subject: "Engineering Mathematics (Rakesh Sir)[NYB 313]" }
            ],
            "Wednesday": [
                { time: "08:00 - 09:40", subject: "AutoCAD Lab (Anubhav Sir)[VIB 217]" },
                { time: "09:40 - 10:30", subject: "Basic Electrical Electronics (Roopayali Ma'am)[NYB 202]" },
                { time: "11:20 - 12:05", subject: "Applied Physics (Rishi Raj Sir)[NYB 202]" }
            ],
            "Thursday": [
                { time: "08:00 - 08:50", subject: "Applied Physics (Rishi Raj Sir)[NYB 202]" },
                { time: "08:50 - 09:40", subject: "C++ (Nidhi Ma'am)[NYB 202]" },
                { time: "09:40 - 11:20", subject: "Applied Physics Lab (Rishi Raj Sir)[VIB 113]" },
                { time: "12:05 - 12:50", subject: "Maths Tut (Rakesh Sir)[NYB 218]" }
            ],
            "Friday": [
                { time: "08:00 - 08:50", subject: "Basic Electrical Electronics (Roopayali Ma'am)[NYB 202]" },
                { time: "08:50 - 09:40", subject: "Engineering Mathematics (Rakesh Sir)[NYB 202]" },
                { time: "10:30 - 11:20", subject: "C++ (Nidhi Ma'am)[NYB 107]" },
                { time: "11:20 - 12:50", subject: "Advance Excel Lab (Raminder Ma'am)[NYB 405]" }
            ],
            "Saturday": [
                { time: "08:00 - 08:50", subject: "Applied Physics (Rishi Raj Sir)[NYB 302]" },
                { time: "08:50 - 09:40", subject: "Professional Skills (Suruchi Ma'am)[NYB 106]" },
                { time: "09:40 - 11:20", subject: "C++ Lab (Nidhi Ma'am)[NYB 218]" }
            ],
            "Sunday": []
        };

        const START_DATE_STR = "2026-01-19";

        // ==========================================
        // 2. SETUP & DB
        // ==========================================
        document.getElementById('mainBody').classList.remove('hidden');
        if (!localStorage.getItem('userName')) localStorage.setItem('userName', 'Student');
        const uName = localStorage.getItem('userName');
        if (document.getElementById('headerUserName')) document.getElementById('headerUserName').innerText = uName;
        if (document.getElementById('dropdownUserName')) document.getElementById('dropdownUserName').innerText = uName;

        const uPhoto = localStorage.getItem('userPhoto');
        const img = document.getElementById('headerUserName').parentElement.parentElement.querySelector('img');
        if (img) img.src = uPhoto || `https://api.dicebear.com/7.x/avataaars/svg?seed=${uName}`;

        function getLocalISODate(date) { const offset = date.getTimezoneOffset() * 60000; return new Date(date.getTime() - offset).toISOString().split('T')[0]; }
        function getCleanSubjectName(fullName) { return fullName.split(' (')[0].trim(); }

        let db, activeDate = new Date();
        let globalStats = { total: 0, present: 0, subjects: {} };

        const request = indexedDB.open("EduFlowDB", 3); // Bump version for new store
        request.onupgradeneeded = function (e) {
            db = e.target.result;
            if (!db.objectStoreNames.contains("attendance")) db.createObjectStore("attendance", { keyPath: "id" });
            if (!db.objectStoreNames.contains("holidays")) db.createObjectStore("holidays", { keyPath: "id" });
            if (!db.objectStoreNames.contains("daily_logs")) db.createObjectStore("daily_logs", { keyPath: "id" }); // Tracks saved days
        };
        request.onsuccess = function (e) {
            db = e.target.result;
            renderDailyView();
            calculateStats();
        };

        // DB Helpers
        function checkDB(storeName, key) {
            return new Promise((resolve) => {
                const tx = db.transaction(storeName, "readonly");
                const store = tx.objectStore(storeName);
                const req = store.get(key);
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => resolve(null);
            });
        }
        function getAll(storeName) {
            return new Promise(r => {
                const req = db.transaction(storeName, "readonly").objectStore(storeName).getAll();
                req.onsuccess = () => r(req.result);
            });
        }

        // ==========================================
        // 3. DAILY VIEW & LOGIC
        // ==========================================

        window.changeDay = function (offset) {
            const next = new Date(activeDate);
            next.setDate(activeDate.getDate() + offset);
            const dStr = getLocalISODate(next);
            const today = getLocalISODate(new Date());

            if (dStr < START_DATE_STR || dStr > today) return;
            activeDate = next;
            renderDailyView();
        }

        window.pickDate = function (val) {
            if (!val) return;
            const parts = val.split('-');
            activeDate = new Date(parts[0], parts[1] - 1, parts[2]);
            renderDailyView();
        }

        async function renderDailyView() {
            if (!db) return;
            const dStr = getLocalISODate(activeDate);
            const dayName = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][activeDate.getDay()];
            const todayStr = getLocalISODate(new Date());

            // Header UI
            let title = dayName;
            if (dStr === todayStr) title = "Today";
            else if (dStr === getLocalISODate(new Date(Date.now() - 86400000))) title = "Yesterday";

            document.getElementById('managerDayName').innerText = title;
            document.getElementById('managerDateStr').innerText = activeDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

            const picker = document.getElementById('datePicker');
            picker.value = dStr;
            picker.max = todayStr;
            picker.min = START_DATE_STR;

            // CHECK SAVED STATUS
            const savedLog = await checkDB("daily_logs", dStr);
            const isSaved = !!savedLog;

            // UI TOGGLE: Edit vs Locked
            const editControls = document.getElementById('editControls');
            const lockedControls = document.getElementById('lockedControls');
            const listContainer = document.getElementById('managerListContainer');

            if (isSaved) {
                editControls.classList.add('hidden');
                lockedControls.classList.remove('hidden');
                listContainer.classList.add('locked-state'); // Gray out list
            } else {
                editControls.classList.remove('hidden');
                lockedControls.classList.add('hidden');
                listContainer.classList.remove('locked-state');
            }

            // Holiday Status
            const holidayRec = await checkDB("holidays", dStr);
            const isHoliday = !!holidayRec;

            // Setup Holiday Toggle (Clone to remove listeners)
            const holToggle = document.getElementById('managerHolidayToggle');
            const newHolToggle = holToggle.cloneNode(true);
            holToggle.parentNode.replaceChild(newHolToggle, holToggle);
            newHolToggle.checked = isHoliday;
            newHolToggle.disabled = isSaved; // Disable toggle if saved
            newHolToggle.addEventListener('change', (e) => toggleHolidayUI(e.target.checked));

            // Content Visibility
            const list = document.getElementById('managerClassList');
            const empty = document.getElementById('managerEmptyState');
            const holMsg = document.getElementById('managerHolidayState');
            list.innerHTML = "";

            if (isHoliday) {
                list.classList.add('hidden');
                empty.classList.add('hidden');
                holMsg.classList.remove('hidden');
                return;
            } else {
                holMsg.classList.add('hidden');
            }

            const classes = routine[dayName] || [];
            if (classes.length === 0) {
                list.classList.add('hidden');
                empty.classList.remove('hidden');
                return;
            }

            list.classList.remove('hidden');
            empty.classList.add('hidden');

            // Render Rows
            for (let i = 0; i < classes.length; i++) {
                const item = classes[i];
                const id = `${dStr}_${item.time}_${item.subject}`;
                const record = await checkDB("attendance", id);
                const isPresent = !!record;

                const row = document.createElement('label');
                row.className = `attendance-row p-4 rounded-xl border border-gray-200 bg-white flex items-center justify-between cursor-pointer select-none group hover:border-indigo-300 relative overflow-hidden`;

                row.innerHTML = `
                    <div class="flex items-center gap-3 overflow-hidden z-10">
                        <div class="text-[10px] font-bold text-gray-500 bg-gray-100 px-2 py-1 rounded whitespace-nowrap">${item.time}</div>
                        <h4 class="font-bold text-gray-700 text-sm truncate">${item.subject}</h4>
                    </div>
                    <div class="custom-checkbox flex items-center justify-center z-10">
                        <input type="checkbox" class="hidden peer attendance-checkbox" 
                             data-id="${id}" data-subject="${item.subject}" ${isPresent ? 'checked' : ''} ${isSaved ? 'disabled' : ''}>
                        <div class="w-6 h-6 rounded border-2 border-gray-300 bg-white flex items-center justify-center transition-all peer-checked:scale-110">
                            <svg class="w-4 h-4 text-white hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                        </div>
                    </div>
                `;
                list.appendChild(row);
            }
        }

        // ==========================================
        // 4. DATA ACTIONS (SAVE & RESET)
        // ==========================================

        function toggleHolidayUI(checked) {
            // Visual toggle only until saved? No, holiday logic affects UI immediately
            const list = document.getElementById('managerClassList');
            const holMsg = document.getElementById('managerHolidayState');
            if (checked) {
                list.classList.add('hidden');
                holMsg.classList.remove('hidden');
            } else {
                list.classList.remove('hidden');
                holMsg.classList.add('hidden');
            }
        }

        window.managerMarkAll = function (state) {
            const boxes = document.querySelectorAll('.attendance-checkbox');
            boxes.forEach(b => b.checked = state);
        }

        window.saveDay = async function () {
            const dStr = getLocalISODate(activeDate);
            const isHoliday = document.getElementById('managerHolidayToggle').checked;

            const tx = db.transaction(["attendance", "holidays", "daily_logs"], "readwrite");

            // 1. Save Holiday Status
            if (isHoliday) tx.objectStore("holidays").put({ id: dStr, note: "Holiday" });
            else tx.objectStore("holidays").delete(dStr);

            // 2. Save Attendance (If not holiday)
            if (!isHoliday) {
                const boxes = document.querySelectorAll('.attendance-checkbox');
                boxes.forEach(cb => {
                    if (cb.checked) {
                        tx.objectStore("attendance").put({ id: cb.dataset.id, subject: cb.dataset.subject, date: dStr });
                    } else {
                        tx.objectStore("attendance").delete(cb.dataset.id);
                    }
                });
            }

            // 3. MARK AS SAVED (Log it)
            tx.objectStore("daily_logs").put({ id: dStr, status: 'saved' });

            tx.oncomplete = () => {
                renderDailyView(); // Will trigger gray-out
                calculateStats();  // Will update counts
            };
        }

        window.resetDay = async function () {
            if (!confirm("Are you sure? This will remove this day from your stats until you save again.")) return;

            const dStr = getLocalISODate(activeDate);
            const tx = db.transaction(["daily_logs"], "readwrite");

            // Remove from logs -> UI unlocks, Stats ignore it
            tx.objectStore("daily_logs").delete(dStr);

            tx.oncomplete = () => {
                renderDailyView();
                calculateStats();
            };
        }

        // ==========================================
        // 5. STATS ENGINE (Only Counts Saved Logs)
        // ==========================================

        async function calculateStats() {
            if (!db) return;

            // Get ALL saved logs
            const loggedDays = await getAll("daily_logs");
            const savedDatesSet = new Set(loggedDays.map(l => l.id));

            // Get Data
            const allHolidays = await getAll("holidays");
            const allAttendance = await getAll("attendance");
            const holidaySet = new Set(allHolidays.map(h => h.id));
            const attendanceSet = new Set(allAttendance.map(a => a.id));

            let subjectStats = {};
            // Initialize subjects
            Object.values(routine).flat().forEach(item => {
                const name = getCleanSubjectName(item.subject);
                if (!subjectStats[name]) subjectStats[name] = { held: 0, present: 0 };
            });

            let totalClasses = 0;
            let totalPresent = 0;

            // Iterate ONLY through saved dates found in daily_logs
            savedDatesSet.forEach(dStr => {
                // If it's a holiday, skip calculation for classes
                if (holidaySet.has(dStr)) return;

                // Determine Day Name
                const dateObj = new Date(dStr);
                const dayName = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][dateObj.getDay()];
                const classes = routine[dayName] || [];

                classes.forEach(cls => {
                    const id = `${dStr}_${cls.time}_${cls.subject}`;
                    const name = getCleanSubjectName(cls.subject);

                    totalClasses++;
                    if (subjectStats[name]) subjectStats[name].held++;

                    if (attendanceSet.has(id)) {
                        totalPresent++;
                        if (subjectStats[name]) subjectStats[name].present++;
                    }
                });
            });

            // Update UI
            document.getElementById('totalClasses').innerText = totalClasses;
            document.getElementById('totalPresent').innerText = totalPresent;
            document.getElementById('totalAbsent').innerText = totalClasses - totalPresent;

            const overall = totalClasses === 0 ? 0 : Math.round((totalPresent / totalClasses) * 100);
            document.getElementById('overallPercent').innerText = totalClasses === 0 ? "--%" : overall + "%";

            // Render Subjects
            const subContainer = document.getElementById('subjectWiseList');
            subContainer.innerHTML = "";
            Object.entries(subjectStats).forEach(([sub, data]) => {
                const pct = data.held === 0 ? 0 : Math.round((data.present / data.held) * 100);
                let color = pct < 75 ? "red" : (pct < 85 ? "yellow" : "green");

                const div = document.createElement('div');
                div.className = "p-4 border border-gray-100 rounded-xl bg-gray-50";
                div.innerHTML = `
                    <div class="flex justify-between mb-2">
                        <span class="font-bold text-gray-700 text-sm">${sub}</span>
                        <span class="text-xs font-bold text-${color}-600 bg-white px-2 py-1 rounded border">${pct}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                        <div class="bg-${color}-500 h-2" style="width: ${pct}%"></div>
                    </div>
                `;
                subContainer.appendChild(div);
            });
            globalStats = { total: totalClasses, present: totalPresent, subjects: subjectStats };
        }

        window.openAnalysis = function () {
            const { total, present, subjects } = globalStats;
            const pct = total === 0 ? 0 : Math.round((present / total) * 100);

            let needed = Math.ceil(3 * total - 4 * present);
            const targetEl = document.getElementById('targetText');

            if (pct >= 75) {
                const buffer = Math.floor((4 * present - 3 * total) / 3);
                targetEl.innerHTML = `<span class="text-green-600">Safe!</span> <div class="text-sm font-normal text-gray-500">Can miss ${buffer} classes.</div>`;
            } else {
                targetEl.innerHTML = `<span class="text-indigo-600">${needed} Classes</span> <div class="text-sm font-normal text-gray-500">needed to hit 75%</div>`;
            }

            const critEl = document.getElementById('criticalSubjects');
            critEl.innerHTML = "";
            let hasCrit = false;
            Object.entries(subjects).forEach(([sub, data]) => {
                const subPct = data.held === 0 ? 0 : (data.present / data.held) * 100;
                if (subPct < 75) {
                    hasCrit = true;
                    critEl.innerHTML += `<div class="bg-red-50 p-2 rounded text-sm flex justify-between"><span class="font-bold text-red-800">${sub}</span><span class="text-red-600 font-bold">${Math.round(subPct)}%</span></div>`;
                }
            });
            if (!hasCrit) critEl.innerHTML = "<div class='text-gray-400 text-center text-sm'>No subjects at risk.</div>";

            document.getElementById('analysisModal').classList.add('active');
        }
    </script>
</body>

</html>